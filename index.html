<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'/>
  <title>DRAFT-CSF Interface</title>
  <meta name = 'viewport' content='initial-scale=1, maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

</head>
<body>
<!--map object -->
<nav id='Menu'>
	<p id="Menu-Explanation"> <b>Layers</b> <br> Click buttons to toggle on/off</p>
</nav>

<div id='map'></div>

<style>
/*map style*/
#map {
      position:absolute;
      top:0;
      bottom:0;
      width:100%;
      z-index: 0;
     }
 /*popups - divs are set dynamically in the toggle functions below. This is why they are not seen in the <body> above */
    .mapboxgl-popup {
     max-width: 350px;
     font: 12px/20px 'Helvetica Neue', sans-serif;
    }
     html .mapboxgl-popup-content {
     padding: 0px;
     -webkit-box-shadow: 0 0 1px 1px rgba(0,0,0,0.2);
     box-shadow: 0 0 1px 1px rgba(0,0,0,0.2);
     opacity: 0.95;
     }
     .mapboxgl-popup h3 {
     	color: #000000;
     	font-size: 16px;
     	font-weight: bold;
     	padding-left: 15px;
     	padding-right: 25px;
     }
     .mapboxgl-popup p {
     	color: #000000;
     	font-size: 13px;
     	font-weight: none;
     	padding-left: 15px;
     	padding-right: 25px;
     }
#Menu {
      background-color: rgba(78,78,78,0.85);
      position: absolute;
      color: rgba(255,255,255,0.75);
      display: block;
      margin: 5px;
      padding-top: 10px;
      padding-bottom: 10px;
      z-index: 1;
      top: 100px;
      right: 25px;
      border-radius: 10px;
      width: 250px;
      border: 1px solid rgba(0,0,0,0.4);
      font: 15px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      color: rgba(255,255,255,0.75);
      z-index: 2;
      }
#Menu-Explanation {
      display: block;
      margin: 5px;
      padding: 5px;
      text-decoration: none;
      border-top: 1px solid rgba(0,0,0,0.25);
      text-align: center;
      color: rgba(255,255,255,0.75);
      z-index: 3;
      }
       /*zoning menu "buttons" style. See colour specifications below. Also, see toggle javascript functions below*/
#Menu a {
      display: block;
      margin: 5px;
      padding: 5px;
      text-decoration: none;
      border-bottom: 1px solid rgba(0,0,0,0.25);
      text-align: center;
      color: rgba(255,255,255,0.75);
      z-index: 3;
      }
#Menu a:last-child {
      border: none;
      }
#Menu a:hover {
      background-color: #FFFFFF;
      opacity: 0.75;
      color: #404040;
      font: bold;
      }
/*zoning menu "buttons" colours. See toggle javascript functions below*/
#Menu a.Pop-change  {
      background-color: #DEDEDE;
      color: #ffffff;
      }
/*hover styles for toggle buttons*/
#Menu a.active {
      background: #DEDEDE;
      }
html .mapboxgl-ctrl-top-right {
      top: 50px;
      right: 85px;
      }
html .mapboxgl-ctrl-group{
      width: 250px;
      margin: 10px 0px;
      border-radius: 0;
      -moz-box-shadow: 0px 0px 2px rgba(0,0,0,0.1);
      -webkit-box-shadow: 0px 0px 2px rgba(0,0,0,0.1);
      box-shadow: none;
      overflow: hidden;
      background: transparent;
      z-index:4;
      }
html .mapboxgl-ctrl-group button {
      width: 35px;
      height: 35px;
      display: inline-block;
      padding: 0;
      outline: none;
      border: none;
      border-bottom: none;
      box-sizing: border-box;
      cursor: pointer;
      background-color: rgba(107,107,107,0.85);
      border-radius: 25px;
      margin: 0 7px 0 0;
      top: 0px;
      float: right;
      }
</style>


<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoic3RvcnByaW1lIiwiYSI6InR6YWtmU2MifQ.mzm3c3_RSxKKc5MgUe0Fig';
    var map = new mapboxgl.Map({
      container: 'map', //container id
      style: 'mapbox://styles/storprime/cjdalgxvfayh22rnuqvpq2gaq', //new satellite image updated
      center: [-79.459,43.807],
      zoom: 11, //starting zoom
      bearing: 0, // starting direction
      pitch: 0, //starting pitch
    });
    map.on('style.load', function() {
      // zoom and rotation controls for the <map>
        map.addControl (new mapboxgl.NavigationControl());
        map.setLight({
          'anchor':'map',
          'color':'white',
          'intensity': 0.40,
          'position': [45,45,45,],
        });
        //add sources
        map.addSource('Pop_Change_weighted-75kmmv', {
          type: "vector",
          url: "mapbox://storprime.av9c7wif"
        });

        map.addSource('GGH_Lower_Tier_Municipalities-7tfoce', {
          type: "vector",
          url: "mapbox://storprime.amfeem9r"
        });

        map.addSource('GGH_Upper_Tier_Municipalities-0no6kp', {
          type: "vector",
          url: "mapbox://storprime.a9d493uz"
        });//cylinders





        map.addLayer({
          'id': 'Growth (by CT)',
          'type':'fill',
          'source': 'Pop_Change_weighted-75kmmv',
          'source-layer': 'Pop_Change_weighted-75kmmv',
          'layout': {
            		visibility: 'none'
          	},
          'paint': {
            'fill-color': {
              'property': 'DensityWeighted_Value',
              'type':'interval',
              'stops': [
              [-39, '#F0DFFF'],
              [0, '#e4f4b6'],
              [5, '#c9e99f'],
              [10, '#a9dc8e'],
              [15, '#88cd80'],
              [20, '#68be71'],
              [25, '#48af60'],
              [50, '#0c4b26'],
              [80, '#158244'],
              [100, '#00271e']
            ]},
            'fill-opacity': 0.75
          },
        },'water')

      map.addLayer({
        'id': 'Hovers',
        'type':'line',
        'source': 'Pop_Change_weighted-75kmmv',
        'source-layer': 'Pop_Change_weighted-75kmmv',
        'paint': {
          'line-color': '#656565',
          'line-width': 5,
          'line-blur': 2,
          'line-opacity': 1
        },
      },)

      map.addLayer({
        'id': 'GGH-Lower',
        'type':'line',
        'source': 'GGH_Lower_Tier_Municipalities-7tfoce',
        'source-layer': 'GGH_Lower_Tier_Municipalities-7tfoce',
        'paint': {
          'line-color': '#656565',
          'line-width': 2,
          'line-blur': 3,
          'line-opacity': 1
        },
      },)

      map.addLayer({
        'id': 'GGH-Upper',
        'type':'line',
        'source': 'GGH_Upper_Tier_Municipalities-0no6kp',
        'source-layer': 'GGH_Upper_Tier_Municipalities-0no6kp',
        'paint': {
          'line-color': '#656565',
          'line-width': 3,
          'line-blur': 6,
          'line-opacity': 1
        },
      },)


  });
//set the filter function for toggleableZoningLayerIds
/* zoning categories popups*/
map.on ('click', function (e){
/* query the feature that is clicked*/
  var features = map.queryRenderedFeatures(e.point, { layers: ['Growth (by CT)']}); //THIS NEEDS TO BE THE ACTIVE LAYER
  /* if the queried features array has objects  - has length - then return then return*/
  var fcoord = e.lngLat
  map.flyTo({center: fcoord, zoom: 11.5})
  if (!features.length){
		  return;}
    /* capture in a new variable the first feature clicked*/
    var feature = features[0]; //key to the interactive opacity change
    /* set a new popup object at the clicked point*/
    var popup = new mapboxgl.Popup()
    .setLngLat(map.unproject(e.point))
    /* dynamically create the html content of each popup based on concatenating pre-written html and certain attribute / property fields */
    .setHTML('<h3 class=Variable Title>Population Change</h3> <p class=Count><b>Change: </b>'+feature.properties.Pop_difference+'</p>' )//set the click box html
    /* add popup to the map object*/
    .addTo(map);
  });
/*set cursor style on hover for buildings*/
map.on('mousemove', function (e) {
  var features = map.queryRenderedFeatures(e.point, { layers: ['Growth (by CT)'] }); //THIS NEEDS TO BE THE ACTIVE LAYER
  map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
  });
  /*set DA highlight on hover*/
  map.on('mousemove', function (e) {
  	var hovFeatures = map.queryRenderedFeatures(e.point, {layers: ['Growth (by CT)']});
  	if (hovFeatures.length) {
  		map.setFilter('Hovers', ["==", "ctuid",hovFeatures[0].properties.ctuid]);}
  	else {
  		map.setFilter('Hovers', ["==", "ctuid", ""]);
  		}
  });
  /*dynamically create buttons for each layer.*/
var toggleableMapLayerIds = ['Growth (by CT)'];
for (var i = 0; i < toggleableMapLayerIds.length; i++){
  var id = toggleableMapLayerIds[i];
  var link = document.createElement('a');
  link.href = '#';
  link.className = id;
  link.textContent = id;
  link.onclick = function (e) {
  	var clickedLayer = this.textContent;
  	e.preventDefault();
  	e.stopPropagation();
  	/*find out if the layer that the button references is visible or not. If not visible, on click make it visible and vice versa*/
  	var visibility = map.getLayoutProperty(clickedLayer, 'visibility');
  	if (visibility === 'visible') {
  		map.setLayoutProperty(clickedLayer, 'visibility', 'none');
  		this.className = '';}
  	else {
  		this.className = clickedLayer;
  		map.setLayoutProperty(clickedLayer, 'visibility','visible');
  		};
  	};
    /*dynamically assign html to the "link" - the toggle button*/
    var mapLayers = document.getElementById('Menu');
    mapLayers.appendChild(link);
};
</script>

</body>
</html>

